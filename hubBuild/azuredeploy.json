{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {

    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "hubNamePrefix": {
      "type": "string",
      "maxLength": 3,
      "minLength": 3,
      "metadata": {
        "description": "A unique three character prefix identifying the environment"
      }
    },
    "customerDevUatDesktopPrefix":{
        "type": "string"
      },
    "customerDevUatInfrastructurePrefix":{
      "type":"string"
    },
    "customerDevUatDesktopNetwork": {
      "maxLength": 22,
      "minLength": 10,
      "type": "string"
    },
    "tagCostCentreId": {
      "type": "string"
    },
    "tagSalesOrderId":{
      "type":"string"
    },
    "hubIpPrefix": {
      "maxLength": 22,
      "minLength": 10,
      "type": "string"
    },
    "lowerHubNetThirdOctet": {
      "maxLength": 11,
      "minLength": 3,
      "type": "string"
    },
    "upperHubNetThirdOctet": {
      "maxLength": 11,
      "minLength": 3,
      "type": "string"
    }
  },
  "variables": {

    "templateLink":"https://raw.githubusercontent.com/bjowett-block/Lab-WVD/master",
    "TEMPLATES": {
      "Hub-DCVM": {
        "LINK": "[concat(variables('templateLink'), '/hubBuild/Common/Compute/ARM/Hub-DCVM.json')]"
      },
      "Hub-MGMTVM": {
        "LINK": "[concat(variables('templateLink'), '/hubBuild/Common/Compute/ARM/Hub-MGMTVM.json')]"
      },
        "Hub-NICS": {
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Compute/Hub-VMNICS.json')]"
      },
        "Hub-ASG": {
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Network/Hub-ASG.json')]"
      },
        "Hub-IPG": {
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Network/Hub-IPG.json')]"
      },
      "Hub-NSG": {
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Network/Hub-NSG.json')]"
      },
      "Hub-VNET": {
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Network/Hub-VNET.json')]"
      },
      "Hub-PIP": {
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Network/Hub-PIP.json')]"
      },
      "Hub-RT": {
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Network/Hub-RT.json')]"
      },
      "Hub-AFW": {
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Network/Hub-AFW.json')]"
      },
        "Hub-VNG": {
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Network/Hub-VNG.json')]"
      },
        "Hub-VPN": {
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Network/Hub-VPN.json')]"
      },
        "Hub-LNG": {
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Network/Hub-LNG.json')]"
      },
       "Hub-AA" :{
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Services/Hub-AA.json')]"
      },
       "Hub-KV" :{
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Services/Hub-KV.json')]"
      },
        "Hub-LAW" :{
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Services/Hub-LAW.json')]"
      },
        "Hub-RSV" :{
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Services/Hub-RSV.json')]"
      },
        "Hub-SA" :{
        "Link": "[concat(variables('templateLink'), '/hubBuild/Common/Services/Hub-SA.json')]"
      },
       "Hub-DSA" : {
         "Link" : "[concat(variables('templateLink'), '/hubBuild/Common/Storage/Hub-DSA.json')]"
       }
    },
    "hubAaName":"[concat(parameters('hubNamePrefix'),'hub-aa01')]",
    "hubkeyVaultName":"[concat(parameters('hubNamePrefix'),'hub-kv01')]",
    "hubNsgName": "[concat(parameters('hubNamePrefix'),'hub-nsg01')]",
    "hubVnetName": "[concat(parameters('hubNamePrefix'),'hub-vnet01')]",
    "hubLawName": "[concat(parameters('hubNamePrefix'),'hub-law01')]",
    "hubDsaName": "[concat(parameters('hubNamePrefix'),'hubdsa01')]",
    "hubRt01Name": "[concat(parameters('hubNamePrefix'),'hubrt01')]",
    "hubRt02Name": "[concat(parameters('hubNamePrefix'),'hubrt02')]",
    "customerDevUatDesktopPrefixName": "[concat(parameters('hubNamePrefix'),'-Customer-Desktop-DEVUAT-Prefix')]",
    "customerDevUatInfrastructurePrefixName": "[concat(parameters('hubNamePrefix'),'-Customer-Infrastructure-DEVUAT-Prefix')]",
    "hubFirewallName": "[concat(parameters('hubNamePrefix'),'hub-afw01')]",
    


    "hubSharedServicesSubnetRange": "[concat(parameters('upperHubNetThirdOctet'),'.0/24')]",
    "hubDomainServicesSubnetRange": "[concat(parameters('lowerHubNetThirdOctet'),'.0/28')]",
    "hubBastionSubnetRange": "[concat(parameters('lowerHubNetThirdOctet'),'.16/29')]",
    "hubGatewayServicesSubnetRange": "[concat(parameters('lowerHubNetThirdOctet'),'.32/27')]",
    "hubDmzSubnetRange": "[concat(parameters('lowerHubNetThirdOctet'),'.64/27')]",
    "hubAzureFirewallSubnetRange": "[concat(parameters('lowerHubNetThirdOctet'),'.128/26')]",
    "hubDefaultGatewayIp":"[concat(parameters('lowerHubNetThirdOctet'),'.132')]",


    "hubFirewallPipName": "[concat(parameters('hubNamePrefix'),'hubafw-pip01')]",
    "hubVngPipName01": "[concat(parameters('hubNamePrefix'),'hubvng-pip01')]",
    "hubVngPipName02": "[concat(parameters('hubNamePrefix'),'hubvng-pip02')]",
    "hubMgmtServerName": "[concat(parameters('hubNamePrefix'),'hubmgmtvm01')]",
    "hubMgmt01VmIp": "[concat(parameters('upperHubNetThirdOctet'),'.4')]",
    "hubMgmtServerNicName": "[concat(parameters('hubNamePrefix'),'hubmgmtvm01-nic')]",
    "hubUksDc01ServerName": "[concat(parameters('hubNamePrefix'),'hubadcvm01')]",
    "hubUksDc01VmIp": "[concat(parameters('lowerHubNetThirdOctet'),'.4')]",
    "hubUksDc01ServerNicName": "[concat(parameters('hubNamePrefix'), variables('hubUksDc01ServerName'),'-NIC')]",
    "hubUksDc02ServerName": "[concat(parameters('hubNamePrefix'),'hubadcvm02')]",
    "hubUksDc02VmIp": "[concat(parameters('lowerHubNetThirdOctet'),'.5')]",
    "hubUksDc02ServerNicName": "[concat(parameters('hubNamePrefix'), variables('hubUksDc02ServerName'),'-NIC')]",


 
    "spokeDesktopIpGroup": "[concat(subscription().id,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Network/ipGroups/Spoke-Desktop-IP-Group')]",
    "spokeIpGroup": "[concat(subscription().id,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Network/ipGroups/Spoke-IP-Group')]",
    "emis1IpGroup": "[concat(subscription().id,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Network/ipGroups/EMIS-Group1-IP-Group')]",
    "emis2IpGroup": "[concat(subscription().id,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Network/ipGroups/EMIS-Group2-IP-Group')]",
    "systemOneIpGroup": "[concat(subscription().id,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Network/ipGroups/SystemOne-IP-Group')]",
    "hubAddIpGroup": "[concat(subscription().id,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Network/ipGroups/HubADDS-IP-Group')]",
    "hscnIpGroup": "[concat(subscription().id,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Network/ipGroups/HSCN-IP-Group')]"
  },
  "resources": [
{
    "type":"Microsoft.Resources/deployments",
    "name": "Deploy_LAWandAA",
    "apiVersion": "2018-05-01",
    "properties": {
      "mode":"Incremental",
      "templateLink":{
        "uri": "[variables('TEMPLATES')['Hub-LAW'].Link]",
        "contentVersion": "1.0.0.0"
      },
      "parameters":{
         "hubLawName": {
            "value":"[variables('hubLawName')]"
        },
        "hubaAName":{
          "value":"[variables('hubAaName')]"
        },
        "tagSalesorderId":{
          "value":"[parameters('tagSalesOrderId')]"
        },
        "tagCostCentreId":{
          "value": "[parameters('tagCostCentreId')]"
        },
      "location": {
            "value": "[parameters('location')]"
          }

    } 
    }
    },   
    {
      "type": "Microsoft.Resources/deployments",
      "name": "Deploy_HubNetworkSecurityGateway",
      "apiVersion": "2018-05-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('Templates')['Hub-NSG'].Link]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "hubNsgName": {
            "value": "[variables('hubNsgName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tagCostCentreId":{
            "value":"[parameters('tagCostCentreId')]"
          },
          "tagSalesOrderId":{
            "value":"[parameters('tagSalesOrderId')]"
          },
          "hubMgmt01VmIp": {
            "value": "[variables('hubMgmt01VmIp')]"
          },
          "hubUksDc01VmIp": {
            "value": "[variables('hubUksDc01VmIp')]"
          },
          "hubUksDc02VmIp": {
            "value": "[variables('hubUksDc02VmIp')]"
          },
          "customerDesktopNetwork":{
            "value":"[parameters('customerDevUatDesktopNetwork')]"
          },
          "hubDmzSubnetRange": {
            "value": "[variables('hubDmzSubnetRange')]"
          },
          "hubSharedServicesSubnetRange": {
            "value": "[variables('hubSharedServicesSubnetRange')]"
          }
        }
      }
    },
    {
  "name": "Deploy_HubDiagnosticStorage",
  "type": "Microsoft.Resources/deployments",
  "apiVersion": "2019-10-01",
  "properties": {
    "mode": "Incremental",
    "templateLink": {
      "uri": "[variables('Templates')['Hub-DSA'].Link]",
      "contentVersion": "1.0.0.0"
    },
    "parameters": {
      "storageAccountName": {
        "value": "[variables('hubDsaName')]"
      },
      "location":{
        "value":"[parameters('location')]"
      },
       "tagSalesOrderId":{
        "value": "[parameters('tagSalesOrderId')]"
  
      },
      "tagCostCentreId": {
        "value": "[parameters('tagCostCentreId')]"
      }
    }
  }
},
{
 "name": "Deploy_HubPublicIPAddresses",
  "type": "Microsoft.Resources/deployments",
  "apiVersion": "2019-10-01",
  "properties": {
    "mode": "Incremental",
    "templateLink": {
      "uri": "[variables('Templates')['Hub-PIP'].Link]",
      "contentVersion": "1.0.0.0"
    },
    "parameters": {
    "hubFirewallPipName": {
      "value":"[variables('hubFirewallPipName')]"
    },
    "hubVngPipName01": {
      "value":"[variables('hubVngPipName01')]"
    },
    "hubVngPipName02": {
      "value":"[variables('hubVngPipName02')]"
    },
    "location": {
      "value":"[parameters('location')]"
    },
    "tagCostCentreId":{
      "value": "[parameters('tagCostCentreId')]"
        },
    "tagSalesOrderId":{
      "value": "[parameters('tagSalesOrderId')]"
        }

    }
    
    }
  
},
{
  "name": "Deploy_Routingtables",
  "type": "Microsoft.Resources/deployments",
  "apiVersion": "2019-10-01",
  "properties": {
    "mode": "Incremental",
    "templateLink": {
      "uri": "[variables('Templates')['Hub-RT'].Link]",
      "contentVersion": "1.0.0.0"
    },
"parameters": {
  "hubRt01Name":{
    "value":"[variables('hubRt01Name')]"
  },
   "hubRt02Name":{
    "value":"[variables('hubRt02Name')]"
  },
  "location":{
    "value":"[parameters('location')]"
  },
  "hubDefaultGatewayIp":{
    "value":"[variables('hubDefaultGatewayIp')]"
  },
  "customerDevUatDesktopPrefixName":{
    "value" : "[variables('customerDevUatDesktopPrefixName')]"
  },
  "customerDevUatDesktopPrefix":{
    "value" : "[parameters('customerDevUatDesktopPrefix')]"
  },
   "customerDevUatInfrastructurePrefixName":{
    "value" : "[variables('customerDevUatInfrastructurePrefixName')]"
  },
  "customerDevUatInfrastructurePrefix": {
    "value": "[parameters('customerDevUatInfrastructurePrefix')]"
  },
   "tagCostCentreId":{
    "value": "[parameters('tagCostCentreId')]"
  },
     "tagSalesOrderId":{
      "value": "[parameters('tagSalesOrderId')]"  
  }


}
  }
  
},

{
  "name": "Deploy_HubVirtualNetwork",
  "dependsOn": [
        "Microsoft.Resources/deployments/Deploy_HubNetworkSecurityGateway",
        "Deploy_Routingtables"
      ],
  "type": "Microsoft.Resources/deployments",
  "apiVersion": "2019-10-01",
  "properties": {
    "mode": "Incremental",
    "templateLink": {
      "uri": "[variables('Templates')['Hub-VNET'].Link]",
      "contentVersion": "1.0.0.0"
    },
    "parameters": {
      "hubVnetName":{
        "value":"[variables('hubVnetName')]"
      },
      "location": {
        "value": "[parameters('location')]"
      },
     "hubIpPrefix": {
        "value":"[parameters('hubIpPrefix')]"
      },
      "hubSharedServicesSubnetRange": {
        "value": "[variables('hubSharedServicesSubnetRange')]"
      },
      "hubDomainServicesSubnetRange": {
        "value":"[variables('hubDomainServicesSubnetRange')]"
      },
 
      "hubGatewayServicesSubnetRange": {
      "value":"[variables('hubGatewayServicesSubnetRange')]"
      },
      "hubDmzSubnetRange": {
        "value":"[variables('hubDmzSubnetRange')]"
      },
      "hubAzureFirewallSubnetRange": {
        "value":"[variables('hubAzureFirewallSubnetRange')]"
      },
      "hubDc01VmIp": {
        "value":"[variables('hubUksDc01VmIp')]"
      },
      "hubDc02VmIp": {
        "value":"[variables('hubUksDc01VmIp')]"
      },
      "tagSalesOrderId":{
        "value": "[parameters('tagSalesOrderId')]"
  
      },
      "tagCostCentreId": {
        "value": "[parameters('tagCostCentreId')]"
      },
      "hubNsgName": {
            "value": "[variables('hubNsgName')]"
      },
      "hubRt01Name":{
            "value": "[variables('hubRt01Name')]"
      },
      "hubRt02Name":{
            "value": "[variables('hubRt02Name')]"
      }
     

  }
}   
},
{
  "name": "Deploy_IPGroups",
  "dependsOn": [
        "Microsoft.Resources/deployments/Deploy_HubNetworkSecurityGateway"
      ],
  "type": "Microsoft.Resources/deployments",
  "apiVersion": "2019-10-01",
  "properties": {
    "mode": "Incremental",
    "templateLink": {
      "uri": "[variables('Templates')['Hub-IPG'].Link]",
      "contentVersion": "1.0.0.0"
    },
"parameters": {
     "customerDesktopNetwork":{
        "value":"[parameters('customerDevUatDesktopNetwork')]"
        },
      "customerDesktopIpPrefix":{
        "value": "[parameters('customerDevUatDesktopPrefix')]"
      },
      "customerInfrastructureIpPrefix":{
        "value": "[parameters('customerDevUatInfrastructurePrefix')]"
      },
      "location": {
        "value": "[parameters('location')]"
      },
     "hubDc01VmIp": {
        "value":"[variables('hubUksDc01VmIp')]"
      },
      "hubDc02VmIp": {
        "value":"[variables('hubUksDc01VmIp')]"
      },
       "tagSalesOrderId":{
        "value": "[parameters('tagSalesOrderId')]"
  
      },
      "tagCostCentreId": {
        "value": "[parameters('tagCostCentreId')]"
      }
}
  }
  
},
{
  "name": "Deploy_AzureFirewall",
  "dependsOn": [
        "Microsoft.Resources/deployments/Deploy_HubVirtualNetwork",
        "Microsoft.Resources/deployments/Deploy_HubPublicIPAddresses",
        "Microsoft.Resources/deployments/Deploy_IPGroups"
      ],
  "type": "Microsoft.Resources/deployments",
  "apiVersion": "2019-10-01",
  "properties": {
    "mode": "Incremental",
    "templateLink": {
      "uri": "[variables('Templates')['Hub-AFW'].Link]",
      "contentVersion": "1.0.0.0"
    },
"parameters": {
    "hubFirewallName": {
      "value": "[variables('hubFirewallName')]"
    },
    "location": {
      "value": "[parameters('location')]"
    },
    "hubVnetName": {
      "value": "[variables('hubVnetName')]"
    },
    "hubFirewallPipName": {
      "value": "[variables('hubFirewallPipName')]"
    },
    "spokeIpGroup": {
      "value": "[variables ('spokeIpGroup')]"
    },
    "spokeDesktopIpGroup": {
      "value": "[variables('spokeDesktopIpGroup')]"
    },
    "emis1IpGroup": {
      "value": "[variables('emis1IpGroup')]"
    },
    "emis2IpGroup": {
       "value": "[variables('emis2IpGroup')]"
    },
    "systemOneIpGroup": {
      "value": "[variables('systemOneIpGroup')]"
    },
    "hubAddIpGroup": {
      "value": "[variables('hubAddIpGroup')]"
    },
    "hscnIpGroup": {
      "value": "[variables('hscnIpGroup')]"
    },
    "hubSharedServicesSubnetRange": {
      "value": "[variables('hubSharedServicesSubnetRange')]"
    },
    "hubDmzSubnetRange": {
      "value": "[variables('hubDmzSubnetRange')]"
    },
    "tagSalesOrderId":{
        "value": "[parameters('tagSalesOrderId')]"
      },
    "tagCostCentreId": {
        "value": "[parameters('tagCostCentreId')]"
      }

}
  }
  
}




  ],
    "outputs": {
    }
  }
