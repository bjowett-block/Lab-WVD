{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "tagCustomerName": {
      "type": "string"
    },
    "hubName": {
      "type": "string"
    },
    "tagSalesOrderId": {
      "type": "string"
    },
    "customerDesktopPrefix": {
      "type": "string"
    },
    "customerInfrastructurePrefix": {
      "type": "string"
    }
  },
  "variables": {
    "hubVnetName" : "[concat(parameters('hubName'), 'vnet01')]",
    "hubRgName" : "[concat(parameters('hubName'), 'rg01')]",
    "customerNsgName": "[concat(parameters('tagCustomerName'), 'nsg01')]",
    "customerVnetName": "[concat(parameters('tagCustomerName'), 'vnet01')]",
    "customerRtName": "[concat(parameters('tagCustomerName'), 'rt01')]",
    "customerSa01Name": "[concat(parameters('tagCustomerName'), 'sa01')]",
    "customerSa02Name": "[concat(parameters('tagCustomerName'), 'sa02')]",
    "customerSa03Name": "[concat(parameters('tagCustomerName'), 'sa03')]",
    "customerDesktopSubnetName": "[concat(parameters('tagCustomerName'), '-Desktop')]",
    "customerInfrastructureSubnetName": "[concat(parameters('tagCustomerName'), '-Infrastructure')]",
    "vnetPeerNameSpoketoHub" : "[concat(variables('customerVnetName'),'/',variables('customerVnetName'),'-to-',variables('hubVnetName'),'-vnet-peer')]"
  },
  "resources": [
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2020-04-01",
      "name": "[variables('customerNsgName')]",
      "location": "uksouth",
      "tags": {
        "Owner": "Block Solutions",
        "Customer Name": "[parameters('tagCustomerName')]",
        "Department": "Workspace and Cloud",
        "Environment": "Production",
        "Location": "UK South",
        "Cost Centre": "PCW",
        "Sales Order ID": "[parameters('tagSalesOrderId')]"
      },
      "properties": {
        "securityRules": [
          {
            "name": "Restrict-East-West-Desktop-Traffic-In",
            "properties": {
              "description": "Restrict East West Traffic Between Production Desktop Hosts\n",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "destinationAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "access": "Deny",
              "priority": 100,
              "direction": "Inbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Restrict-East-West-Infra-Traffic-In",
            "properties": {
              "description": "Restrict East West Traffic Between Production Infrastructure Hosts\n",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
              "destinationAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
              "access": "Deny",
              "priority": 101,
              "direction": "Inbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Allow-MgmtServer-to-Desktops-In",
            "properties": {
              "description": "Allow Hub management server access to customer desktops\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "sourceAddressPrefix": "172.18.1.4",
              "destinationAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "access": "Allow",
              "priority": 110,
              "direction": "Inbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [
                "3389",
                "5986"
              ],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Allow-MgmtServer-to-Infrastructure-In",
            "properties": {
              "description": "Allow Hub management server access to customer infrastructure servers\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "sourceAddressPrefix": "172.18.1.4",
              "destinationAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
              "access": "Allow",
              "priority": 111,
              "direction": "Inbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [
                "3389",
                "5986"
              ],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Allow-MgmtServer-to-Desktop-ICMP-In",
            "properties": {
              "description": "Allow Hub management server to ping customer desktops\n",
              "protocol": "ICMP",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "172.18.1.4",
              "destinationAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "access": "Allow",
              "priority": 112,
              "direction": "Inbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Allow-MgmtServer-to-Infrastructure-ICMP-In",
            "properties": {
              "description": "Allow Hub management server to ping customer infrastructure\n",
              "protocol": "ICMP",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "172.18.1.4",
              "destinationAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
              "access": "Allow",
              "priority": 113,
              "direction": "Inbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Deny-Any",
            "properties": {
              "description": "Deny All undefined inbound traffic to customer spoke",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*",
              "access": "Deny",
              "priority": 1000,
              "direction": "Inbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Restrict-East-West-Desktop-Traffic-Out",
            "properties": {
              "description": "Restrict East West Traffic Between Production Desktop Hosts\n",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "destinationAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "access": "Deny",
              "priority": 100,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Restrict-East-West-Infra-Traffic-Out",
            "properties": {
              "description": "Restrict East West Traffic Between Production Infrastructure Hosts\n",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
              "destinationAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
              "access": "Deny",
              "priority": 101,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Allow-Desktop-to-ADDS-TCP-Out",
            "properties": {
              "description": "Allow customer desktop Services to access Domain Services in hub on TCP protocols\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "access": "Allow",
              "priority": 110,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [
                "53",
                "88",
                "135",
                "139",
                "389",
                "445",
                "464",
                "636",
                "3268",
                "3269",
                "49152-65535"
              ],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": [
                "172.18.0.4",
                "172.18.0.5"
              ]
            }
          },
          {
            "name": "Allow-Desktop-to-ADDS-UDP-Out",
            "properties": {
              "description": "Allow customer desktop Services to access Domain Services in hub on UDP protocols\n",
              "protocol": "UDP",
              "sourcePortRange": "*",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "access": "Allow",
              "priority": 111,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [
                "53",
                "88",
                "123",
                "135",
                "389",
                "445",
                "464",
                "636"
              ],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": [
                "172.18.0.4",
                "172.18.0.5"
              ]
            }
          },
          {
            "name": "Allow-Desktop-to-ADDS-Ping-Out",
            "properties": {
              "description": "Allow customer desktop Services to  ping Domain Services in hub on ICMP protocols\n",
              "protocol": "ICMP",
              "sourcePortRange": "*",
              "destinationPortRange": "8080",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "access": "Allow",
              "priority": 112,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": [
                "172.18.0.4",
                "172.18.0.5"
              ]
            }
          },
          {
            "name": "Allow-Infrastructure-to-ADDS-TCP-Out",
            "properties": {
              "description": "Allow customer Infrastructure Services to access Domain Services in hub on TCP protocols\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
              "access": "Allow",
              "priority": 113,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [
                "53",
                "88",
                "135",
                "139",
                "389",
                "445",
                "464",
                "636",
                "3268",
                "3269",
                "49152-65535"
              ],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": [
                "172.18.0.4",
                "172.18.0.5"
              ]
            }
          },
          {
            "name": "Allow-Infrastructure-to-ADDS-UDP-Out",
            "properties": {
              "description": "Allow customer Infrastructure Services to access Domain Services in hub on UDP protocols\n",
              "protocol": "UDP",
              "sourcePortRange": "*",
              "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
              "access": "Allow",
              "priority": 114,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [
                "53",
                "88",
                "123",
                "135",
                "389",
                "445",
                "464",
                "636"
              ],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": [
                "172.18.0.4",
                "172.18.0.5"
              ]
            }
          },
          {
            "name": "Allow-Infrastructure-to-ADDS-Ping-Out",
            "properties": {
              "description": "Allow customer Infrastructure Services to  ping Domain Services in hub on ICMP protocols\n",
              "protocol": "ICMP",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
              "access": "Allow",
              "priority": 115,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": [
                "172.18.0.4",
                "172.18.0.5"
              ]
            }
          },
          {
            "name": "Allow-Desktop-to-EMIS1-TCP-Out",
            "properties": {
              "description": "Allow customer desktops to connect to EMIS1 Services on TCP protocols\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "access": "Allow",
              "priority": 120,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [
                "80",
                "443",
                "8080",
                "33962",
                "33956",
                "33963",
                "33964",
                "33966",
                "33969",
                "33957"
              ],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": [
                "10.207.112.0/22",
                "10.207.116.0/22"
              ]
            }
          },
          {
            "name": "Allow-Desktop-to-EMIS2-TCP-Out",
            "properties": {
              "description": "Allow customer desktops to connect to EMIS2 Services on TCP protocols\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "access": "Allow",
              "priority": 121,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [
                "80",
                "8080",
                "443"
              ],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": [
                "185.13.72.0/22",
                "149.11.42.48"
              ]
            }
          },
          {
            "name": "Allow-Desktop-to-SystmOne-TCP-Out",
            "properties": {
              "description": "Allow customer desktop to connect to SystmOne services on TCP Protocols\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "2130-2140",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "access": "Allow",
              "priority": 130,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": [
                "20.146.120.128/25",
                "20.146.248.128/25"
              ]
            }
          },
          {
            "name": "Allow-Desktop-to-SystmOne-UDP-Out",
            "properties": {
              "description": "Allow customer desktop to connect to SystmOne services on UDP Protocols\n",
              "protocol": "UDP",
              "sourcePortRange": "*",
              "destinationPortRange": "2120-2130",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "access": "Allow",
              "priority": 131,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": [
                "20.146.120.128/25",
                "20.146.248.0/25"
              ]
            }
          },
          {
            "name": "Allow-Desktop-to-AzureKMS-TCP-Out",
            "properties": {
              "description": "Allow access from customer desktop to Azure KMS services for product activation\n",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "1688",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 310,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Allow-Infrastructure-to-AzureKMS-TCP-Out",
            "properties": {
              "description": "Allow access from customer infrastructure to Azure KMS services for product activation\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "1688",
              "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 311,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Allow-Desktop-to-Web-TCP-Out",
            "properties": {
              "description": "Allow access from customer desktop to standard web services\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 312,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [
                "80",
                "443",
                "8080"
              ],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Allow-Infrastructure-to-Web-TCP-Out",
            "properties": {
              "description": "Allow access from customer Infrastructure to standard web services\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 313,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [
                "80",
                "443",
                "8080"
              ],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Allow-Desktop-to-UKSouth-Storage-Out",
            "properties": {
              "description": "Allow Desktops access to UK South Storage accounts\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "445",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "destinationAddressPrefix": "Storage.UKSouth",
              "access": "Allow",
              "priority": 400,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "Allow-Desktop-to-UKWest-Storage-Out",
            "properties": {
              "description": "Allow Desktops access to UK West Storage accounts\n",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "445",
              "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
              "destinationAddressPrefix": "Storage.UKWest",
              "access": "Allow",
              "priority": 401,
              "direction": "Outbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/routeTables",
      "apiVersion": "2020-04-01",
      "name": "[variables('customerRtName')]",
      "location": "uksouth",
      "tags": {
        "Owner": "Block Solutions",
        "Customer Name": "[parameters('tagCustomerName')]",
        "Department": "Workspace and Cloud",
        "Environment": "Production",
        "Location": "UK South",
        "Cost Centre": "PCW",
        "Sales Order ID": "[parameters('tagSalesOrderId')]"
      },
      "properties": {
        "disableBgpRoutePropagation": true,
        "routes": [
          {
            "name": "Default-Gateway",
            "properties": {
              "addressPrefix": "0.0.0.0/0",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "172.18.0.132"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Desktop-to-ADDS-Ping-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow customer desktop Services to  ping Domain Services in hub on ICMP protocols\n",
        "protocol": "ICMP",
        "sourcePortRange": "*",
        "destinationPortRange": "8080",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "access": "Allow",
        "priority": 112,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": [
          "172.18.0.4",
          "172.18.0.5"
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Desktop-to-ADDS-TCP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow customer desktop Services to access Domain Services in hub on TCP protocols\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "access": "Allow",
        "priority": 110,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [
          "53",
          "88",
          "135",
          "139",
          "389",
          "445",
          "464",
          "636",
          "3268",
          "3269",
          "49152-65535"
        ],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": [
          "172.18.0.4",
          "172.18.0.5"
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Desktop-to-ADDS-UDP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow customer desktop Services to access Domain Services in hub on UDP protocols\n",
        "protocol": "UDP",
        "sourcePortRange": "*",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "access": "Allow",
        "priority": 111,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [
          "53",
          "88",
          "123",
          "135",
          "389",
          "445",
          "464",
          "636"
        ],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": [
          "172.18.0.4",
          "172.18.0.5"
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Desktop-to-AzureKMS-TCP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow access from customer desktop to Azure KMS services for product activation\n",
        "protocol": "*",
        "sourcePortRange": "*",
        "destinationPortRange": "1688",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "destinationAddressPrefix": "*",
        "access": "Allow",
        "priority": 310,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Desktop-to-EMIS1-TCP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow customer desktops to connect to EMIS1 Services on TCP protocols\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "access": "Allow",
        "priority": 120,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [
          "80",
          "443",
          "8080",
          "33962",
          "33956",
          "33963",
          "33964",
          "33966",
          "33969",
          "33957"
        ],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": [
          "10.207.112.0/22",
          "10.207.116.0/22"
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Desktop-to-EMIS2-TCP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow customer desktops to connect to EMIS2 Services on TCP protocols\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "access": "Allow",
        "priority": 121,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [
          "80",
          "8080",
          "443"
        ],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": [
          "185.13.72.0/22",
          "149.11.42.48"
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Desktop-to-SystmOne-TCP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow customer desktop to connect to SystmOne services on TCP Protocols\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "destinationPortRange": "2130-2140",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "access": "Allow",
        "priority": 130,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": [
          "20.146.120.128/25",
          "20.146.248.128/25"
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Desktop-to-SystmOne-UDP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow customer desktop to connect to SystmOne services on UDP Protocols\n",
        "protocol": "UDP",
        "sourcePortRange": "*",
        "destinationPortRange": "2120-2130",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "access": "Allow",
        "priority": 131,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": [
          "20.146.120.128/25",
          "20.146.248.0/25"
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Desktop-to-UKSouth-Storage-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow Desktops access to UK South Storage accounts\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "destinationPortRange": "445",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "destinationAddressPrefix": "Storage.UKSouth",
        "access": "Allow",
        "priority": 400,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Desktop-to-UKWest-Storage-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow Desktops access to UK West Storage accounts\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "destinationPortRange": "445",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "destinationAddressPrefix": "Storage.UKWest",
        "access": "Allow",
        "priority": 401,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Desktop-to-Web-TCP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow access from customer desktop to standard web services\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "destinationAddressPrefix": "*",
        "access": "Allow",
        "priority": 312,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [
          "80",
          "443",
          "8080"
        ],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Infrastructure-to-ADDS-Ping-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow customer Infrastructure Services to  ping Domain Services in hub on ICMP protocols\n",
        "protocol": "ICMP",
        "sourcePortRange": "*",
        "destinationPortRange": "*",
        "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "access": "Allow",
        "priority": 115,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": [
          "172.18.0.4",
          "172.18.0.5"
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Infrastructure-to-ADDS-TCP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow customer Infrastructure Services to access Domain Services in hub on TCP protocols\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "access": "Allow",
        "priority": 113,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [
          "53",
          "88",
          "135",
          "139",
          "389",
          "445",
          "464",
          "636",
          "3268",
          "3269",
          "49152-65535"
        ],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": [
          "172.18.0.4",
          "172.18.0.5"
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Infrastructure-to-ADDS-UDP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow customer Infrastructure Services to access Domain Services in hub on UDP protocols\n",
        "protocol": "UDP",
        "sourcePortRange": "*",
        "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "access": "Allow",
        "priority": 114,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [
          "53",
          "88",
          "123",
          "135",
          "389",
          "445",
          "464",
          "636"
        ],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": [
          "172.18.0.4",
          "172.18.0.5"
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Infrastructure-to-AzureKMS-TCP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow access from customer infrastructure to Azure KMS services for product activation\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "destinationPortRange": "1688",
        "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "destinationAddressPrefix": "*",
        "access": "Allow",
        "priority": 311,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-Infrastructure-to-Web-TCP-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow access from customer Infrastructure to standard web services\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "destinationAddressPrefix": "*",
        "access": "Allow",
        "priority": 313,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [
          "80",
          "443",
          "8080"
        ],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-MgmtServer-to-Desktop-ICMP-In')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow Hub management server to ping customer desktops\n",
        "protocol": "ICMP",
        "sourcePortRange": "*",
        "destinationPortRange": "*",
        "sourceAddressPrefix": "172.18.1.4",
        "destinationAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "access": "Allow",
        "priority": 112,
        "direction": "Inbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-MgmtServer-to-Desktops-In')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow Hub management server access to customer desktops\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "sourceAddressPrefix": "172.18.1.4",
        "destinationAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "access": "Allow",
        "priority": 110,
        "direction": "Inbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [
          "3389",
          "5986"
        ],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-MgmtServer-to-Infrastructure-ICMP-In')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow Hub management server to ping customer infrastructure\n",
        "protocol": "ICMP",
        "sourcePortRange": "*",
        "destinationPortRange": "*",
        "sourceAddressPrefix": "172.18.1.4",
        "destinationAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "access": "Allow",
        "priority": 113,
        "direction": "Inbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Allow-MgmtServer-to-Infrastructure-In')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Allow Hub management server access to customer infrastructure servers\n",
        "protocol": "TCP",
        "sourcePortRange": "*",
        "sourceAddressPrefix": "172.18.1.4",
        "destinationAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "access": "Allow",
        "priority": 111,
        "direction": "Inbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [
          "3389",
          "5986"
        ],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Deny-Any')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Deny All undefined inbound traffic to customer spoke",
        "protocol": "*",
        "sourcePortRange": "*",
        "destinationPortRange": "*",
        "sourceAddressPrefix": "*",
        "destinationAddressPrefix": "*",
        "access": "Deny",
        "priority": 1000,
        "direction": "Inbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Restrict-East-West-Desktop-Traffic-In')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Restrict East West Traffic Between Production Desktop Hosts\n",
        "protocol": "*",
        "sourcePortRange": "*",
        "destinationPortRange": "*",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "destinationAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "access": "Deny",
        "priority": 100,
        "direction": "Inbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Restrict-East-West-Desktop-Traffic-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Restrict East West Traffic Between Production Desktop Hosts\n",
        "protocol": "*",
        "sourcePortRange": "*",
        "destinationPortRange": "*",
        "sourceAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "destinationAddressPrefix": "[parameters('customerDesktopPrefix')]",
        "access": "Deny",
        "priority": 100,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Restrict-East-West-Infra-Traffic-In')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Restrict East West Traffic Between Production Infrastructure Hosts\n",
        "protocol": "*",
        "sourcePortRange": "*",
        "destinationPortRange": "*",
        "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "destinationAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "access": "Deny",
        "priority": 101,
        "direction": "Inbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerNsgName'), '/Restrict-East-West-Infra-Traffic-Out')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
      ],
      "properties": {
        "description": "Restrict East West Traffic Between Production Infrastructure Hosts\n",
        "protocol": "*",
        "sourcePortRange": "*",
        "destinationPortRange": "*",
        "sourceAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "destinationAddressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "access": "Deny",
        "priority": 101,
        "direction": "Outbound",
        "sourcePortRanges": [],
        "destinationPortRanges": [],
        "sourceAddressPrefixes": [],
        "destinationAddressPrefixes": []
      }
    },
    
    
    

    
    
   
    {
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerVnetName'), '/',variables('customerDesktopSubnetName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', variables('customerVnetName'))]",
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]",
        "[resourceId('Microsoft.Network/routeTables', variables('customerRtName'))]"
      ],
      "properties": {
        "addressPrefix": "[parameters('customerDesktopPrefix')]",
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
        },
        "routeTable": {
          "id": "[resourceId('Microsoft.Network/routeTables', variables('customerRtName'))]"
        },
        "serviceEndpoints": [
          {
            "service": "Microsoft.Storage",
            "locations": [
              "uksouth",
              "ukwest"
            ]
          }
        ],
        "delegations": [],
        "privateEndpointNetworkPolicies": "Enabled",
        "privateLinkServiceNetworkPolicies": "Enabled"
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "apiVersion": "2020-04-01",
      "name": "[concat(variables('customerVnetName'), '/',variables('customerInfrastructureSubnetName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', variables('customerVnetName'))]",
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]",
        "[resourceId('Microsoft.Network/routeTables', variables('customerRtName'))]"
      ],
      "properties": {
        "addressPrefix": "[parameters('customerInfrastructurePrefix')]",
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('customerNsgName'))]"
        },
        "routeTable": {
          "id": "[resourceId('Microsoft.Network/routeTables', variables('customerRtName'))]"
        },
        "serviceEndpoints": [
          {
            "service": "Microsoft.Storage",
            "locations": [
              "uksouth",
              "ukwest"
            ]
          }
        ],
        "delegations": [],
        "privateEndpointNetworkPolicies": "Enabled",
        "privateLinkServiceNetworkPolicies": "Enabled"
      }
    }
  ]
}