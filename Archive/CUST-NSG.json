{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "customerDesktopNetwork":{
            "type": "string"
        },
        "customerNsgName":{
            "type": "string"
        },
        "hubAddsIp01": {
            "type": "string"
        },
        "hubAddsIp02": {
            "type": "string"
        },
        "hscnIpNetworks": {
            "type": "string"
        },
        "hubMgmtServerIp":{
            "type": "string"
        },
        "location": {
            "type": "string"
        },
        "customerAsgName": {
            "type":"String"
        }
    },
    
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.Network/applicationSecurityGroups",
            "apiVersion": "2019-12-01",
            "name": "[parameters('customerAsgName')]",
            "location": "[parameters('location')]",
            "properties": {}
        },

        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-12-01",
            "name": "[parameters('customerNsgName')]",
            "location": "[parameters('location')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "Desktop-To-EMIS1",
                        "properties": {
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "access": "Allow",
                            "priority": 200,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [
                                "80",
                                "443",
                                "8080",
                                "33962",
                                "33956",
                                "33963",
                                "33964",
                                "33966",
                                "33969",
                                "33957"
                            ],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [
                                "[parameters('hubAddsIp01')]",
                                "[parameters('hubAddsIp02')]"
                            ],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "Desktop-To-EMIS2",
                        "properties": {
                            "description": "Allow Customer Desktop Access to EMIS2-TCP",
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "access": "Allow",
                            "priority": 201,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [
                                "80",
                                "8080",
                                "443"
                            ],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [
                                "185.13.72.0/22",
                                "149.11.42.48"
                            ],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "SystemOne-TCP",
                        "properties": {
                            "description": "Allow Customer Desktop Access to SystemOne-TCP",
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "2130-2140",
                            "access": "Allow",
                            "priority": 202,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [
                                "20.146.120.128/25",
                                "20.146.248.128/25"
                            ],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "SystemOne-UDP",
                        "properties": {
                            "description": "Allow Customer Desktop Access to SystemOne-UDP",
                            "protocol": "UDP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "2120-2130",
                            "access": "Allow",
                            "priority": 203,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [
                                "20.146.120.128/25",
                                "20.146.248.0/25"
                            ],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "Restrict-HSCN-Traffic",
                        "properties": {
                            "description": "Restrict HSCN Traffic catch all to stop undefined traffic from Desktop environment to HSCN",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "parameters('customerDesktopNetwork')]",
                            "access": "Deny",
                            "priority": 300,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [
                                "[parameters('hscnIpNetworks')]"
                            ]
                        }
                    },
                    {
                        "name": "Outbound-Internet-Access",
                        "properties": {
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 400,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [
                                "80",
                                "443"
                            ],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "Desktop-to-ADDS-TCP",
                        "properties": {
                            "description": "Allow Customer Desktop  Access to Azure ADDS_TCP",
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "access": "Allow",
                            "priority": 101,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [
                                "53",
                                "88",
                                "135",
                                "445",
                                "464",
                                "3268",
                                "3269",
                                "49152-65535",
                                "636"
                            ],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [
                                "[parameters('hubAddsIp01')]",
                                "[parameters('hubAddsIp02')]"
                            ],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "Desktop-to-ADDS-UDP",
                        "properties": {
                            "description": "Allow Customer Desktop  Access to Azure ADDS_UDP",
                            "protocol": "UDP",
                            "sourcePortRange": "*",
                            "access": "Allow",
                            "priority": 102,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [
                                "53",
                                "88",
                                "135",
                                "389",
                                "445",
                                "464",
                                "123",
                                "636"
                            ],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [
                                "[parameters('hubAddsIp01')]",
                                "[parameters('hubAddsIp02')]"
                            ],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "Inbound-MGMT-from-Infra-net",
                        "properties": {
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "sourceAddressPrefix": "[parameters('hubMgmtServerIp')]",
                            "access": "Allow",
                            "priority": 101,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [
                                "3389",
                                "5986"
                            ],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [],
                            "destinationApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "Catchall-Infra-desktop_deny",
                        "properties": {
                            "description": "Deny-All",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 1000,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Restrict-Desktop-EAST_WEST",
                        "properties": {
                            "description": "Restrict East West Traffic Between Production Desktop Hosts",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "access": "Deny",
                            "priority": 100,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ],
                            "destinationApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "ICMP_DESKTOP-To-ADDS",
                        "properties": {
                            "description": "Allow Customer Desktop  Ping Access to Azure ADDS",
                            "protocol": "ICMP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "access": "Allow",
                            "priority": 103,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [
                                "[parameters('hubAddsIp01')]",
                                "[parameters('hubAddsIp02')]"
                            ],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "Desktop-To-INTKMS",
                        "properties": {
                            "description": "Allow Customer Desktops to Access Internal KMS",
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "1688",
                            "destinationAddressPrefix": "[parameters('hubMgmtServerIp')]",
                            "access": "Allow",
                            "priority": 104,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "Desktop-Storage",
                        "properties": {
                            "description": "Allow Customer Desktops File Share Access to Azure storage",
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "destinationAddressPrefix": "[concat ('Storage.',parameters('location'))]",
                            "access": "Allow",
                            "priority": 106,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "Desktop-To-AzureKMS",
                        "properties": {
                            "description": "Allow Customer Desktop Access to Azure KMS",
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "1688",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 401,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "Deny-All-Out",
                        "properties": {
                            "description": "Deny-All",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 1000,
                            "direction": "Outbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Restrict-Desktop-EAST_WEST-IN",
                        "properties": {
                            "description": "Restrict East West Traffic Between Production Desktop Hosts",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "access": "Deny",
                            "priority": 100,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [],
                            "sourceApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ],
                            "destinationApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "Allow-MGMTBOX-Desktop-ICMP",
                        "properties": {
                            "description": "Allow Management host access to Desktop ping",
                            "protocol": "ICMP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "[parameters('hubMgmtServerIp')]",
                            "access": "Allow",
                            "priority": 102,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": [],
                            "destinationApplicationSecurityGroups": [
                                {
                                    "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Allow-MGMTBOX-Desktop-ICMP')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Allow Management host access to Desktop ping",
                "protocol": "ICMP",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "[parameters('hubMgmtServerIp')]",
                "access": "Allow",
                "priority": 102,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [],
                "destinationApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Restrict-HSCN-Traffic')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Restrict HSCN Traffic catch all to stop undefined traffic from Desktop environment to HSCN",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "[parameters('customerDesktopNetwork')]",
                "access": "Deny",
                "priority": 300,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [
                 "[parameters('hscnIpNetworks')]"
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Catchall-Infra-desktop_deny')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Deny-All",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Deny",
                "priority": 1000,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Deny-All-Out')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Deny-All",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Deny",
                "priority": 1000,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Desktop-to-ADDS-TCP')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Allow Customer Desktop  Access to Azure ADDS_TCP",
                "protocol": "TCP",
                "sourcePortRange": "*",
                "access": "Allow",
                "priority": 101,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [
                    "53",
                    "88",
                    "135",
                    "445",
                    "464",
                    "3268",
                    "3269",
                    "49152-65535",
                    "636"
                ],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [
                   "[parameters('hubAddsIp01')]",
                   "[parameters('hubAddsIp02')]"
                ],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Desktop-to-ADDS-UDP')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Allow Customer Desktop  Access to Azure ADDS_UDP",
                "protocol": "UDP",
                "sourcePortRange": "*",
                "access": "Allow",
                "priority": 102,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [
                    "53",
                    "88",
                    "135",
                    "389",
                    "445",
                    "464",
                    "123",
                    "636"
                ],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [
                    "[parameters('hubAddsIp01')]",
                    "[parameters('hubAddsIp02')]"
                ],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Desktop-To-AzureKMS')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Allow Customer Desktop Access to Azure KMS",
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationPortRange": "1688",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 401,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Desktop-To-EMIS1')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "protocol": "TCP",
                "sourcePortRange": "*",
                "access": "Allow",
                "priority": 200,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [
                    "80",
                    "443",
                    "8080",
                    "33962",
                    "33956",
                    "33963",
                    "33964",
                    "33966",
                    "33969",
                    "33957"
                ],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [
                    "10.207.112.0/22",
                    "10.207.116.0/22"
                ],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Desktop-To-EMIS2')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Allow Customer Desktop Access to EMIS2-TCP",
                "protocol": "TCP",
                "sourcePortRange": "*",
                "access": "Allow",
                "priority": 201,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [
                    "80",
                    "8080",
                    "443"
                ],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [
                    "185.13.72.0/22",
                    "149.11.42.48"
                ],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Desktop-To-INTKMS')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Allow Customer Desktops to Access Internal KMS",
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationPortRange": "1688",
                "destinationAddressPrefix": "[parameters('hubMgmtServerIp')]",
                "access": "Allow",
                "priority": 104,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Desktop-Storage')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Allow Customer Desktops File Share Access to Azure storage",
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "destinationAddressPrefix": "[concat ('Storage.',parameters('location'))]",
                "access": "Allow",
                "priority": 106,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/ICMP_DESKTOP-To-ADDS')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Allow Customer Desktop  Ping Access to Azure ADDS",
                "protocol": "ICMP",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "access": "Allow",
                "priority": 103,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [
                    "[parameters('hubAddsIp01')]",
                    "[parameters('hubAddsIp02')]"
                ],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Inbound-MGMT-from-Infra-net')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "protocol": "TCP",
                "sourcePortRange": "*",
                "sourceAddressPrefix": "[parameters('hubMgmtServerIp')]",
                "access": "Allow",
                "priority": 101,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [
                    "3389",
                    "5986"
                ],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [],
                "destinationApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Outbound-Internet-Access')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 400,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [
                    "80",
                    "443"
                ],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Restrict-Desktop-EAST_WEST')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Restrict East West Traffic Between Production Desktop Hosts",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "access": "Deny",
                "priority": 100,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ],
                "destinationApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/Restrict-Desktop-EAST_WEST-IN')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Restrict East West Traffic Between Production Desktop Hosts",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "access": "Deny",
                "priority": 100,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ],
                "destinationApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/SystemOne-TCP')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Allow Customer Desktop Access to SystemOne-TCP",
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationPortRange": "2130-2140",
                "access": "Allow",
                "priority": 202,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [
                    "20.146.120.128/25",
                    "20.146.248.128/25"
                ],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-12-01",
            "name": "[concat(parameters('customerNsgName'), '/SystemOne-UDP')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('customerNsgName'))]"
            ],
            "properties": {
                "description": "Allow Customer Desktop Access to SystemOne-UDP",
                "protocol": "UDP",
                "sourcePortRange": "*",
                "destinationPortRange": "2120-2130",
                "access": "Allow",
                "priority": 203,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": [
                    "20.146.120.128/25",
                    "20.146.248.0/25"
                ],
                "sourceApplicationSecurityGroups": [
                    {
                        "id": "[resourceId('Microsoft.Network/applicationSecurityGroups/', parameters('customerAsgName'))]"
                    }
                ]
            }
        }
    ]
}